// ส่วนหัวที่จำเป็น
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ------------------------------------
// โมเดลสำหรับร้านขายอุปกรณ์ไอที (Update: Admin Role added)
// ------------------------------------

model User {
  user_id    String   @id @default(auto()) @map("_id") @db.ObjectId
  username   String
  email      String   @unique
  password   String
  picture    String?
  
  // ✅ เพิ่มบรรทัดนี้: เพื่อกำหนดสิทธิ์ผู้ใช้ (ค่าปกติคือ "user")
  role       String   @default("user") 
  
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  
  cartItems  OrderItem[] 
  orders     Order[]     
  reviews    Review[]
}

model Product {
  product_id          String   @id @default(auto()) @map("_id") @db.ObjectId
  product_name        String
  brand               String?
  price               Float
  stock               Int      @default(0)
  description         String?
  product_image       String?
  specifications      String?
  
  added_to_list_count Int      @default(0)
  average_rating      Float    @default(0)
  review_count        Int      @default(0)
  
  categories          ProductCategory[]
  orderItems          OrderItem[]
  reviews             Review[]
}

// สถานะของ Order และ OrderItem
enum OrderStatus {
  IN_CART     // อยู่ในตะกร้า (ยังไม่กดสั่ง)
  PENDING     // กดสั่งแล้ว รอชำระเงิน/รอตรวจสอบ
  PAID        // ชำระเงินแล้ว/ยืนยันแล้ว
  SHIPPED     // จัดส่งแล้ว
  COMPLETED   // สำเร็จ (ลูกค้ารับของแล้ว)
  CANCELLED   // ยกเลิก
}

// โมเดลใบสั่งซื้อ (Header)
model Order {
  order_id     String      @id @default(auto()) @map("_id") @db.ObjectId
  user_id      String      @db.ObjectId
  
  total_price  Float       // ราคารวมของออเดอร์นี้
  slip_image   String?     // รูปสลิปโอนเงิน
  address      String?     // ที่อยู่จัดส่ง
  status       OrderStatus @default(PENDING)
  
  created_at   DateTime    @default(now())
  updated_at   DateTime    @updatedAt

  user         User        @relation(fields: [user_id], references: [user_id])
  orderItems   OrderItem[] // รายการสินค้าในออเดอร์นี้
}

// รายการสินค้า (ใช้ทั้งเป็นตะกร้า และ รายการในบิล)
model OrderItem {
  order_item_id String      @id @default(auto()) @map("_id") @db.ObjectId
  user_id       String      @db.ObjectId
  product_id    String      @db.ObjectId
  order_id      String?     @db.ObjectId // เชื่อมกับใบสั่งซื้อ (ถ้าเป็น null คืออยู่ในตะกร้า)
  
  quantity      Int         @default(1)
  price         Float?      // บันทึกราคา ณ ตอนที่สั่งซื้อ
  status        OrderStatus @default(IN_CART)
  
  add_date      DateTime    @default(now())
  update_date   DateTime    @updatedAt

  user    User    @relation(fields: [user_id], references: [user_id])
  product Product @relation(fields: [product_id], references: [product_id])
  order   Order?  @relation(fields: [order_id], references: [order_id])
}

// ตารางเชื่อม Many-to-Many ระหว่าง Product และ Category
model ProductCategory {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  product_id  String   @db.ObjectId
  category_id String   @db.ObjectId

  product  Product  @relation(fields: [product_id], references: [product_id])
  category Category @relation(fields: [category_id], references: [category_id])

  @@unique([product_id, category_id])
}

model Category {
  category_id String            @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  products    ProductCategory[]
}

model Review {
  review_id   String   @id @default(auto()) @map("_id") @db.ObjectId
  user_id     String   @db.ObjectId
  product_id  String   @db.ObjectId
  rating      Int      @default(0)
  comment     String?
  review_date DateTime @default(now())

  user    User    @relation(fields: [user_id], references: [user_id])
  product Product @relation(fields: [product_id], references: [product_id])

  @@unique([user_id, product_id])
}